Sure, let's dive deeply into `SET TRANSACTION ISOLATION LEVEL` in SQL Server, a fundamental concept for managing concurrency and data consistency.

### What `SET TRANSACTION ISOLATION LEVEL` Does

`SET TRANSACTION ISOLATION LEVEL` specifies the locking and versioning behavior for statements issued by a connection. It dictates how one transaction's modifications are visible to other concurrent transactions and how data is locked to prevent conflicts. It's about finding the right balance between **concurrency** (how many users/processes can access data simultaneously) and **consistency** (how accurate and up-to-date the data seen by each transaction is).

SQL Server supports several isolation levels, which directly relate to the **ACID properties of transactions**, specifically the 'I' for **Isolation**.

### Understanding Transaction Isolation Levels

The ANSI/ISO SQL standard defines four primary isolation levels, each designed to prevent certain types of concurrency phenomena (also known as anomalies):

1.  **Dirty Reads (Read Uncommitted):**
    * Occurs when a transaction reads data that has been modified by another transaction but not yet committed. If the modifying transaction later rolls back, the first transaction has read "dirty" or non-existent data.

2.  **Non-Repeatable Reads:**
    * Occurs when a transaction reads the same row multiple times and gets different values each time. This happens because another transaction has modified and committed changes to that row between the reads.

3.  **Phantom Reads:**
    * Occurs when a transaction executes a query (e.g., `SELECT COUNT(*)` or a range query) twice, and the second execution returns a different set of rows. This happens because another transaction has inserted or deleted rows that fall within the query's criteria between the two reads.

Let's look at the SQL Server isolation levels and what they prevent:

| Isolation Level                                       | Prevents Dirty Reads | Prevents Non-Repeatable Reads | Prevents Phantom Reads | How it works (simplified)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Use Cases                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ```
## What `SET TRANSACTION ISOLATION LEVEL` Does

`SET TRANSACTION ISOLATION LEVEL` in SQL Server specifies how statements in a connection's current transaction will behave regarding locking and row versioning. This effectively controls the balance between **concurrency** (how many users can access data at the same time) and **consistency** (how accurate and up-to-date the data seen by each transaction is).

It's directly tied to the "I" (Isolation) in the **ACID properties of transactions**. The goal of isolation is to ensure that concurrent transactions appear to execute serially, preventing data anomalies that can arise when transactions interleave their operations.

### Understanding Concurrency Phenomena (Anomalies)

To understand isolation levels, it's essential to know the common concurrency anomalies they aim to prevent:

1.  **Dirty Reads (or Uncommitted Dependency):**
    * Occurs when one transaction reads data that has been modified by another transaction but has not yet been committed. If the modifying transaction then rolls back, the data read by the first transaction is "dirty" or non-existent.
    * **Example:** Transaction A updates a row, but hasn't committed. Transaction B reads that updated row. Transaction A then rolls back. Transaction B has read data that was never officially saved.

2.  **Non-Repeatable Reads:**
    * Occurs when a transaction reads the same row multiple times, and the values of that row change between reads because another transaction has modified and committed changes to that row in the interim.
    * **Example:** Transaction A reads a row. Transaction B updates the same row and commits. Transaction A reads the same row again and gets a different value.

3.  **Phantom Reads:**
    * Occurs when a transaction executes a query (e.g., `SELECT COUNT(*)` or a range query) twice, and the second execution returns a different set of rows. This happens because another transaction has inserted or deleted rows that fall within the query's criteria between the two reads.
    * **Example:** Transaction A reads all rows in a table where `Status = 'Pending'`. Transaction B inserts a new row with `Status = 'Pending'` and commits. Transaction A rereads all rows with `Status = 'Pending'` and finds a new "phantom" row.

### SQL Server Isolation Levels

SQL Server offers five isolation levels, each preventing a specific set of anomalies:

#### 1. `READ UNCOMMITTED`
* **Description:** This is the lowest isolation level. It allows a transaction to read data that has been modified by other transactions but not yet committed. This is often referred to as "dirty reads."
* **Prevents:** None of the standard anomalies.
* **How it works:** No shared locks are issued, and no exclusive locks are honored. This means queries run very quickly because they don't wait for other transactions.
* **Pros:** Highest concurrency.
* **Cons:** Lowest consistency. Can read invalid data.
* **Use Cases:**
    * When data accuracy is not critical (e.g., generating rough statistical reports where a slight inaccuracy is acceptable).
    * When high throughput and minimal blocking are paramount, and the risk of reading dirty data is low or managed by the application.
    * **Caution:** Generally discouraged for OLTP systems where data integrity is vital.

#### 2. `READ COMMITTED` (Default for SQL Server)
* **Description:** This is the default isolation level for SQL Server. It prevents dirty reads by ensuring that a transaction can only read data that has been committed by other transactions.
* **Prevents:** Dirty Reads.
* **How it works:**
    * When a transaction reads data, it acquires shared (S) locks on the data, which are released immediately after the read.
    * It *honors* exclusive (X) locks held by other transactions, meaning it will wait if another transaction has modified the data it wants to read.
* **Pros:** Good balance between concurrency and consistency for many applications.
* **Cons:** Still susceptible to non-repeatable reads and phantom reads.
* **Use Cases:** Most general-purpose OLTP applications where reading committed data is sufficient.

#### 3. `REPEATABLE READ`
* **Description:** This level guarantees that if a transaction reads a row multiple times, it will always see the same data. It prevents dirty reads and non-repeatable reads.
* **Prevents:** Dirty Reads, Non-Repeatable Reads.
* **How it works:**
    * When a transaction reads data, it acquires shared (S) locks on all data it reads. These locks are held until the **end of the transaction**.
    * This prevents other transactions from modifying any rows read by the `REPEATABLE READ` transaction until it commits or rolls back.
* **Pros:** Stronger consistency than `READ COMMITTED` for repeated reads of the same data.
* **Cons:** Reduced concurrency due to longer-held shared locks, leading to more potential for blocking. Still susceptible to phantom reads.
* **Use Cases:** Scenarios where a transaction needs to ensure that data it has already read does not change before the transaction completes (e.g., complex calculations based on multiple reads of the same data).

#### 4. `SERIALIZABLE`
* **Description:** This is the highest isolation level. It guarantees that if multiple transactions are executed concurrently, the result will be the same as if they were executed serially (one after another). It prevents dirty reads, non-repeatable reads, and phantom reads.
* **Prevents:** Dirty Reads, Non-Repeatable Reads, Phantom Reads.
* **How it works:**
    * Acquires range locks on data (key-range locks for indexes) in addition to shared locks on individual rows.
    * All locks (shared and range) are held until the **end of the transaction**.
    * This prevents other transactions from modifying *or inserting new rows* that would fall into the read range of the `SERIALIZABLE` transaction.
* **Pros:** Highest consistency, guaranteeing strict data isolation.
* **Cons:** Lowest concurrency, significantly increasing the potential for blocking and deadlocks.
* **Use Cases:** Very specific scenarios where absolute data consistency is paramount, and concurrency is less critical (e.g., auditing, financial transactions requiring strict order).

#### 5. `SNAPSHOT` (Row Versioning-based)
* **Description:** A unique isolation level introduced in SQL Server 2005 that provides statement-level read consistency using row versioning in `tempdb`, rather than traditional locking. It prevents dirty reads, non-repeatable reads, and phantom reads without acquiring shared locks on the data being read.
* **Prevents:** Dirty Reads, Non-Repeatable Reads, Phantom Reads.
* **How it works:**
    * When a `SNAPSHOT` transaction starts, it gets a "snapshot" of the committed state of the database at that exact moment.
    * Any data it reads will be the version of that data that was current at the start of the `SNAPSHOT` transaction, regardless of subsequent modifications by other transactions.
    * Modifications made *within* a `SNAPSHOT` transaction acquire locks and create new row versions, but reads by other `SNAPSHOT` transactions continue to use their own initial snapshot.
    * Requires the database option `ALLOW_SNAPSHOT_ISOLATION` to be `ON`.
* **Pros:** High concurrency for read operations (as reads don't block writers, and writers don't block readers). Provides strong consistency guarantees.
* **Cons:** Requires `tempdb` space for row versions, which can increase I/O. Update conflicts (when a `SNAPSHOT` transaction tries to update a row that was changed by another committed transaction after the snapshot began) will cause the `SNAPSHOT` transaction to fail.
* **Use Cases:** Ideal for mixed OLTP/reporting workloads where reports need consistent data without blocking transactional activity.

#### `READ COMMITTED SNAPSHOT ISOLATION` (RCSI)
* **Description:** This is an alternative implementation of `READ COMMITTED` using row versioning instead of shared locks for reads.
* **Prevents:** Dirty Reads.
* **How it works:**
    * Similar to `SNAPSHOT`, it uses row versioning in `tempdb`.
    * Reads in `RCSI` transactions do *not* acquire shared locks. Instead, they read the latest *committed* version of the row available at the time the statement *begins*.
    * Requires the database option `READ_COMMITTED_SNAPSHOT` to be `ON`.
* **Pros:** Significantly reduces blocking for read operations compared to standard `READ COMMITTED`, as readers don't block writers and writers don't block readers. Very popular for OLTP.
* **Cons:** Still susceptible to non-repeatable reads and phantom reads within a transaction (but only if the query changes between reads). Increased `tempdb` usage.
* **Use Cases:** Highly recommended for most modern OLTP systems to improve concurrency while maintaining committed read semantics.

### How to Set Isolation Level

The isolation level can be set at three levels:

1.  **Session Level (using `SET TRANSACTION ISOLATION LEVEL`):** This applies to all transactions and statements for the current connection until changed or the connection closes.
    ```sql
    SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
    ```
2.  **Database Level (using `ALTER DATABASE` for RCSI/SNAPSHOT):**
    ```sql
    ALTER DATABASE YourDatabaseName SET READ_COMMITTED_SNAPSHOT ON;
    ALTER DATABASE YourDatabaseName SET ALLOW_SNAPSHOT_ISOLATION ON;
    ```
3.  **Statement Level (using `WITH` hints):** You can override the session or database isolation level for a single statement using `WITH` hints (e.g., `WITH (NOLOCK)` for `READ UNCOMMITTED`, `WITH (READCOMMITTEDLOCK)` for `READ COMMITTED` when `RCSI` is on).
    ```sql
    SELECT * FROM dbo.YourTable WITH (NOLOCK); -- Effectively READ UNCOMMITTED for this statement
    ```

### Code Examples for Demonstrating Isolation Levels

To demonstrate, we'll need two separate SQL Server Management Studio (SSMS) query windows, simulating two concurrent sessions.

**Setup Script:**

```sql
-- Switch to a test database (or create one)
USE master;
GO

-- Drop database if it exists
IF DB_ID('IsolationLevelTestDB') IS NOT NULL
DROP DATABASE IsolationLevelTestDB;
GO

CREATE DATABASE IsolationLevelTestDB;
GO

USE IsolationLevelTestDB;
GO

-- Create a table for demonstration
CREATE TABLE Accounts (
    AccountID INT PRIMARY KEY,
    Balance DECIMAL(18, 2),
    LastUpdated DATETIME DEFAULT GETDATE()
);
GO

-- Insert some initial data
INSERT INTO Accounts (AccountID, Balance) VALUES
(1, 100.00),
(2, 500.00),
(3, 200.00);
GO

-- Enable Snapshot Isolation for the database (if you want to test SNAPSHOT and RCSI)
-- This requires the database to be in single-user mode for a moment, so run separately if needed.
-- ALTER DATABASE IsolationLevelTestDB SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
-- ALTER DATABASE IsolationLevelTestDB SET ALLOW_SNAPSHOT_ISOLATION ON;
-- ALTER DATABASE IsolationLevelTestDB SET READ_COMMITTED_SNAPSHOT ON;
-- ALTER DATABASE IsolationLevelTestDB SET MULTI_USER;
-- GO
-- Note: It's better to run these ALTER DATABASE commands outside of a demo script to avoid connection issues.
-- For demo purposes, we will assume these are already set if we test SNAPSHOT/RCSI.
```

---

**Scenario 1: Dirty Read (Illustrating `READ UNCOMMITTED` vs. `READ COMMITTED`)**

**Window 1 (Transaction A - Modifying and Not Committing)**

```sql
USE IsolationLevelTestDB;
GO

-- Ensure default isolation level for this demo
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
GO

BEGIN TRAN; -- Start a transaction

-- Update an account balance but DON'T COMMIT
UPDATE Accounts
SET Balance = 1000.00, LastUpdated = GETDATE()
WHERE AccountID = 1;

PRINT 'Transaction A: Updated AccountID 1. Not yet committed.';

-- Keep transaction open for a few seconds to allow Window 2 to read
WAITFOR DELAY '00:00:10';

-- Now, roll back the transaction
ROLLBACK TRAN;

PRINT 'Transaction A: Rolled back changes.';

SELECT 'Window 1 Final Balance:' AS Info, Balance FROM Accounts WHERE AccountID = 1;
```

**Window 2 (Transaction B - Reading)**

```sql
USE IsolationLevelTestDB;
GO

-- Test 1: With READ UNCOMMITTED
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
-- Or use WITH (NOLOCK) hint for a single statement:
-- SELECT AccountID, Balance FROM Accounts WITH (NOLOCK) WHERE AccountID = 1;
GO

PRINT 'Window 2: Reading with READ UNCOMMITTED...';
SELECT AccountID, Balance, LastUpdated FROM Accounts WHERE AccountID = 1;

WAITFOR DELAY '00:00:05'; -- Wait a bit

PRINT 'Window 2: Reading again with READ UNCOMMITTED...';
SELECT AccountID, Balance, LastUpdated FROM Accounts WHERE AccountID = 1;

-- Test 2: With READ COMMITTED
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
GO

PRINT 'Window 2: Reading with READ COMMITTED (will block until A commits/rolls back)...';
SELECT AccountID, Balance, LastUpdated FROM Accounts WHERE AccountID = 1;

PRINT 'Window 2: Read completed for READ COMMITTED.';
```

**Observation:**

* **Window 2 (Reading with `READ UNCOMMITTED`):** When Window 1 updates and pauses, Window 2 (with `READ UNCOMMITTED`) will immediately read `1000.00` for `AccountID = 1`. After Window 1 rolls back, if Window 2 reads again, it will see `100.00` again. This demonstrates reading "dirty" data that was never committed.
* **Window 2 (Reading with `READ COMMITTED`):** When Window 1 updates and pauses, Window 2 (with `READ COMMITTED`) will **block** until Window 1 either commits or rolls back. Only after Window 1 rolls back will Window 2 read `100.00`. This prevents the dirty read.

---

**Scenario 2: Non-Repeatable Read (Illustrating `READ COMMITTED` vs. `REPEATABLE READ`)**

**Window 1 (Transaction A - Long Transaction Reading)**

```sql
USE IsolationLevelTestDB;
GO

SET TRANSACTION ISOLATION LEVEL REPEATABLE READ; -- Change this to READ COMMITTED for comparison
GO

BEGIN TRAN;

PRINT 'Transaction A: First read of AccountID 2...';
SELECT AccountID, Balance, LastUpdated FROM Accounts WHERE AccountID = 2;

PRINT 'Transaction A: Pausing for 10 seconds...';
WAITFOR DELAY '00:00:10';

PRINT 'Transaction A: Second read of AccountID 2...';
SELECT AccountID, Balance, LastUpdated FROM Accounts WHERE AccountID = 2;

COMMIT TRAN;
PRINT 'Transaction A: Committed.';
```

**Window 2 (Transaction B - Updating and Committing)**

```sql
USE IsolationLevelTestDB;
GO

-- Ensure default isolation level for this demo
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
GO

-- Wait for Window 1 to start its transaction and first read
WAITFOR DELAY '00:00:03';

BEGIN TRAN;
PRINT 'Transaction B: Updating AccountID 2...';
UPDATE Accounts
SET Balance = 750.00, LastUpdated = GETDATE()
WHERE AccountID = 2;

COMMIT TRAN;
PRINT 'Transaction B: Committed update.';
```

**Observation:**

* **Window 1 (`SET TRANSACTION ISOLATION LEVEL READ COMMITTED`):**
    * First read: `500.00`.
    * Window 2 updates to `750.00` and commits during Window 1's pause.
    * Second read: `750.00`. This is a **non-repeatable read**.
* **Window 1 (`SET TRANSACTION ISOLATION LEVEL REPEATABLE READ`):**
    * First read: `500.00`.
    * Window 2 tries to `UPDATE` `AccountID = 2`. It will **block** because Window 1 holds a shared lock on that row until its transaction commits.
    * Window 1's second read: `500.00` (unchanged).
    * Window 1 commits, releasing the lock. Window 2's `UPDATE` then proceeds.
    * `REPEATABLE READ` successfully prevented the non-repeatable read by holding locks.

---

**Scenario 3: Phantom Read (Illustrating `REPEATABLE READ` vs. `SERIALIZABLE`)**

**Window 1 (Transaction A - Long Transaction Reading Range)**

```sql
USE IsolationLevelTestDB;
GO

SET TRANSACTION ISOLATION LEVEL REPEATABLE READ; -- Change this to SERIALIZABLE for comparison
GO

BEGIN TRAN;

PRINT 'Transaction A: First COUNT of accounts with Balance < 300...';
SELECT COUNT(*) AS InitialCount FROM Accounts WHERE Balance < 300;

PRINT 'Transaction A: Pausing for 10 seconds...';
WAITFOR DELAY '00:00:10';

PRINT 'Transaction A: Second COUNT of accounts with Balance < 300...';
SELECT COUNT(*) AS FinalCount FROM Accounts WHERE Balance < 300;

COMMIT TRAN;
PRINT 'Transaction A: Committed.';
```

**Window 2 (Transaction B - Inserting New Row)**

```sql
USE IsolationLevelTestDB;
GO

-- Ensure default isolation level
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
GO

-- Wait for Window 1 to start its transaction and first read
WAITFOR DELAY '00:00:03';

BEGIN TRAN;
PRINT 'Transaction B: Inserting new account with Balance < 300...';
INSERT INTO Accounts (AccountID, Balance) VALUES (4, 150.00); -- New phantom row
COMMIT TRAN;
PRINT 'Transaction B: Committed insert.';
```

**Observation:**

* **Window 1 (`SET TRANSACTION ISOLATION LEVEL REPEATABLE READ`):**
    * Initial `COUNT` will be `2` (AccountID 1 & 3, assuming Window 2 has updated Account 2 to 750).
    * Window 2 inserts a new row (`AccountID 4`, `Balance 150.00`) and commits. `REPEATABLE READ` only holds locks on rows it *actually read*, not on the *range* where new rows could be inserted.
    * Second `COUNT` will be `3`. This is a **phantom read**.
* **Window 1 (`SET TRANSACTION ISOLATION LEVEL SERIALIZABLE`):**
    * Initial `COUNT` will be `2`.
    * Window 2 tries to `INSERT` the new row. It will **block** because `SERIALIZABLE` acquires *range locks* (key-range locks on the index covering the `Balance` column) that prevent other transactions from inserting rows that would fall into the read range of Window 1.
    * Window 1's second `COUNT` will be `2` (unchanged).
    * Window 1 commits, releasing the range lock. Window 2's `INSERT` then proceeds.
    * `SERIALIZABLE` successfully prevented the phantom read.

---

**Scenario 4: `SNAPSHOT` Isolation (Requires `ALLOW_SNAPSHOT_ISOLATION ON`)**

First, ensure `ALLOW_SNAPSHOT_ISOLATION` is `ON` for `IsolationLevelTestDB`. If not, run this (requires single-user mode for a moment):

```sql
USE master;
GO
ALTER DATABASE IsolationLevelTestDB SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
ALTER DATABASE IsolationLevelTestDB SET ALLOW_SNAPSHOT_ISOLATION ON;
ALTER DATABASE IsolationLevelTestDB SET MULTI_USER;
GO
USE IsolationLevelTestDB; -- Reconnect to the database
```

**Window 1 (Transaction A - Snapshot Read)**

```sql
USE IsolationLevelTestDB;
GO

SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
GO

BEGIN TRAN;

PRINT 'Transaction A (SNAPSHOT): First read of all accounts...';
SELECT AccountID, Balance, LastUpdated FROM Accounts;

PRINT 'Transaction A (SNAPSHOT): Pausing for 10 seconds...';
WAITFOR DELAY '00:00:10';

PRINT 'Transaction A (SNAPSHOT): Second read of all accounts...';
SELECT AccountID, Balance, LastUpdated FROM Accounts;

COMMIT TRAN;
PRINT 'Transaction A (SNAPSHOT): Committed.';
```

**Window 2 (Transaction B - Concurrent Update & Insert)**

```sql
USE IsolationLevelTestDB;
GO

-- Standard READ COMMITTED behavior for this transaction
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
GO

-- Wait for Window 1 to start its transaction and first read
WAITFOR DELAY '00:00:03';

BEGIN TRAN;
PRINT 'Transaction B: Updating AccountID 1...';
UPDATE Accounts
SET Balance = 1100.00, LastUpdated = GETDATE()
WHERE AccountID = 1;

PRINT 'Transaction B: Inserting new account (AccountID 5)...';
INSERT INTO Accounts (AccountID, Balance) VALUES (5, 99.00);

COMMIT TRAN;
PRINT 'Transaction B: Committed update and insert.';
```

**Observation:**

* **Window 1 (`SNAPSHOT`):**
    * The first `SELECT` will show the state of the database *at the exact moment Window 1's transaction began*. (e.g., Accounts 1, 2, 3 with initial balances).
    * Window 2 updates `AccountID 1` and inserts `AccountID 5` and commits.
    * The second `SELECT` in Window 1 will **still show the original state** (AccountID 1 with old balance, and AccountID 5 will *not* be visible).
* **Key points:**
    * Window 1 **did not block** Window 2.
    * Window 2 **did not block** Window 1's reads.
    * Window 1 consistently saw the database as it was at the *start of its transaction*, demonstrating full consistency (no dirty reads, non-repeatable reads, or phantom reads) without using traditional shared locks for reads.

---

### Conclusion

`SET TRANSACTION ISOLATION LEVEL` is a fundamental concept in SQL Server for managing concurrency and data integrity.

* Choosing the correct isolation level is a trade-off: **higher isolation means greater consistency but typically lower concurrency (more blocking/deadlocks)**, while **lower isolation means higher concurrency but greater risk of data anomalies.**
* **`READ COMMITTED` (default)** is a good starting point for most OLTP systems.
* **`READ COMMITTED SNAPSHOT ISOLATION` (RCSI)** is often the preferred choice for modern OLTP databases to significantly reduce blocking, offering `READ COMMITTED` semantics with versioning benefits.
* **`SNAPSHOT`** provides statement-level read consistency and is excellent for reporting or read-heavy transactions that need to see a consistent view of data over their lifetime.
* `REPEATABLE READ` and `SERIALIZABLE` are strong isolation levels but should be used sparingly due to their heavy locking, which can severely impact concurrency in busy systems.

Understanding these levels and their implications is crucial for designing robust, scalable, and reliable database applications.